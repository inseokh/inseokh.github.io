<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!--<link href="/assets/css/bootstrap.min.css" rel="stylesheet">-->
    <title>Mobile Web Acceleration Demo</title>
    <style>
      #demo-div {color: grey; border-radius: 0.3rem;}
      #demo-div span, #demo-div #num-observed-events {color: black;}
      h1 {margin-top: 0.5rem;}
      h4 {margin-top: 0.66rem; font-size:1.33rem;}
      #demo-div li {line-height: 21px;}
      #demo-div ul {margin-bottom: 0.66rem;}
    </style>
</head>
<body>
<main role="main" class="container">

<h1 align="left">JavaScript Sensor Access Demo</h1>
<p><b>This demo page should be run from a mobile phone or a tablet.</b></p>
<p>This demo page shows how websites can access sensor data from mobile devices using <a href="https://developer.mozilla.org/en-US/docs/Web/Events/devicemotion"><i>deviceorientation</i></a> and <a href="https://developer.mozilla.org/en-US/docs/Web/Events/deviceorientation"><i>devicemotion</i></a> events.</p>

<div id="demo-div">
<a id="start_demo" class="btn btn-lg btn-success py-1" href="#" role="button">Start the demo</a>

<h4 style="margin-top:0.75rem;">Orientation</h4>

<h4>Accelerometer</h4>
<ul>
  <li>(Real-time) X-axis: <span id="Accelerometer_x">0</span><span> m/s<sup>2</sup></span></li>
  <li>(Real-time) Y-axis: <span id="Accelerometer_y">0</span><span> m/s<sup>2</sup></span></li>
  <li>(Real-time) Z-axis: <span id="Accelerometer_z">0</span><span> m/s<sup>2</sup></span></li>
  <li>(Real-time) count : <span id="Accel_count">0</span><span> samples</span></li>
</ul>
<h4>Time remaining: <span id="Time_remain">0</span><span> sec</span></h4>
<h4>Mean intensity: <span id="Accel_mean">0</span><span> m/s<sup>2</sup></span></h4>
</div>
</main>
<script>

function incrementEventCount(){
  let counterElement = document.getElementById("num-observed-events")
  let eventCount = parseInt(counterElement.innerHTML)
  counterElement.innerHTML = eventCount + 1;
}

function updateFieldIfNotNull(fieldName, value, precision=10){
  if (value != null)
    document.getElementById(fieldName).innerHTML = value.toFixed(precision);
}

function handleMotion(event) {
  //updateFieldIfNotNull('Accelerometer_gx', event.accelerationIncludingGravity.x);
  //updateFieldIfNotNull('Accelerometer_gy', event.accelerationIncludingGravity.y);
  //updateFieldIfNotNull('Accelerometer_gz', event.accelerationIncludingGravity.z);
  var ax = event.acceleration.x;
  var ay = event.acceleration.y;
  var az = event.acceleration.z;

  updateFieldIfNotNull('Accelerometer_x', ax);
  updateFieldIfNotNull('Accelerometer_y', ay);
  updateFieldIfNotNull('Accelerometer_z', az);

  //updateFieldIfNotNull('Accelerometer_i', event.interval, 2);

  //updateFieldIfNotNull('Gyroscope_z', event.rotationRate.alpha);
  //updateFieldIfNotNull('Gyroscope_x', event.rotationRate.beta);
  //updateFieldIfNotNull('Gyroscope_y', event.rotationRate.gamma);
  //incrementEventCount();
  total.add(ax, ay, az);
  updateFieldIfNotNull('Accel_count', total.count, precision=0);
}

function totalAccel(){
    this.total = 0;
    this.count = 0;
    this.add = function(ax, ay, az){
        this.total += Math.sqrt(ax**2 + ay**2 + az**2);
        this.count++;
    }
    this.reset = function(){
        this.total = 0;
        this.count = 0;
    }
    this.mean = function(){
        if (this.count == 0) {
            return 0;
        }else{
            return this.total / this.count;
        }
    }
}

function start_accel(){
    total.reset();
    window.addEventListener("devicemotion", handleMotion);
    document.getElementById("start_demo").innerHTML = "Stop demo";
    demo_button.classList.remove('btn-success');
    demo_button.classList.add('btn-danger');
    is_running = true;
    updateFieldIfNotNull("Accel_mean", total.mean(), precision=2);
    var ref = new Date().getTime();
    var timer = setInterval(function() {
        var now = new Date().getTime();
        updateFieldIfNotNull('Time_remain', (now - ref), precision=0);
        if ((now - ref) <= 0) {
            clearInterval(timer);
            stop_accel();
        }
    }, 1000);
}

function stop_accel(){
    window.removeEventListener("devicemotion", handleMotion);
    demo_button.innerHTML = "Start demo";
    demo_button.classList.add('btn-success');
    demo_button.classList.remove('btn-danger');
    is_running = false;
    updateFieldIfNotNull("Accel_mean", total.mean(), precision=2);
}

let total = new totalAccel();
let timer_exp = 5000; // 5 seconds
updateFieldIfNotNull('Time_remain', timer_exp/1000, precision=0);

let is_running = false;
let demo_button = document.getElementById("start_demo");
demo_button.onclick = function(e) {
  e.preventDefault();
  
  // Request permission for iOS 13+ devices
  if (
    DeviceMotionEvent &&
    typeof DeviceMotionEvent.requestPermission === "function"
  ) {
    DeviceMotionEvent.requestPermission();
  }
  
  if (is_running){
      stop_accel();
  }else{
      start_accel();
  }
};


</script>
</body>
</html>

